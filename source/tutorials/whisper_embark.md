---
id: whisper_embark
title: Embark Into Whisper - Making Gossip Easy
layout: tutorials
---

## Intro
In this tutorial we'll learn how to use Ethereum's Whisper protocol and Embark, creating a chat application even simpler than the one we built in [our previous tutorial](./whisper_basic_cli.html). We have again setup a [Github repository](https://github.com/stauts-im/whisper-embark-tutorial) to make it easy for you to follow along.

Embark is a framework for DApp developers that makes building truly decentralized applications easy. It includes support for [smart contracts](https://embark.status.im/docs/contracts_configuration.html), [IPFS and Swarm](https://embark.status.im/docs/storage_deployment.html), [Whisper](https://embark.status.im/docs/messages_configuration.html), [advanced debugging and testing](https://embark.status.im/docs/contracts_testing.html), [front-end code](https://embark.status.im/docs/javascript_usage.html) and [templates for everything](https://embark.status.im/templates/), and an [ecosystem of plugins](https://embark.status.im/plugins/). Please make sure you have the [latest version installed](https://embark.status.im/docs/installation.html). It should be as simple as:

```
npm install -g embark@latest
```

## Setup
Once you have Embark installed, we are ready to begin coding! Execute these commands in a terminal window to clone the repository and install its dependencies:

```bash
git clone https://github.com/status-im/whisper-embark-tutorial.git
cd whisper-embark-tutorial
```

## First run
Now let’s run our website quickly to see all the things Embark will do for us automagically:

```bash
embark run
```

You should see the [Embark dashboard](https://embark.status.im/docs/dashboard.html) in your terminal and be redirected to your browser where Embark will load and then display our skeleton code. In the dashboard we have:

* Contracts - the top left shows which contracts are deployed and their address.
* Modules loaded and running - the top right shows the status of the loaded modules running (or not running) in Embark.
* Log - the middle shows log output.
* Console - on the bottom row there is a console that will let us interact with web3 and ipfs (try it out by typing help to see available commands).

You’ll notice from the logs and from the modules that Embark has started various processes, and webpacked our site for us. Let's take a tour of the barebones dApp. It has several features that are not yet hooked up to whisper, but that's what we're here to learn how to do.

## Coding our dApp

The file `./app/js/index.js` is full of `TODOs` that we need to complete. You'll notice that using Embark, the amount of boilerplate code you need to write is greatly reduced. The idea is that you should be able to focus the vast majority of your time on your dApp's business logic.

In this example, Embark generates a keypair for us. We'll only need to implement code for sending and receiving messages. This is done by using `EmbarkJS.Messages.sendMessage(options)`. Happily, Embark will also hex-encode the data for us, unlike using `web3.utils.shh` directly. This means you can send plain text as we do here:

```js
// Send message via whisper
EmbarkJS.Messages.sendMessage({
    topic: DEFAULT_CHANNEL, 
    data: message
});
```

`sendMessage` accepts an option object that can contain the following attributes:

1. `symKeyID`: if specified, it will send the message to this symmetric key id. Otherwise, it will send to a random symmetric key generated by Embark.
2. `pubKey` is the public key for message encryption (which is used when sending asymmetric messages).
3. Either `symKeyID` or `pubKey` must be present. But you cannot have both.
4. `usePrivateKey` is a boolean that indicates if you're going to use an private key for signing the message, or use Embark's autogenerated random keypair.
5. `privateKeyID` is required if you set `usePrivateKey` to `true`. Here you send the ID of the signing key.
6. `ttl` is the time to live in seconds. The default value is `100`.
7. `powTime` is the maximal time in seconds to be spent on proof of work. The default value is `3`.
8. `powTarget` is the minimal PoW target required for this message. The default value is `0.5`.
9. `topic`: optional when using private keys. It can be an array of strings, or a string that contains the topic for thosee messages. It will be automatically encoded to a 4 bytes hex string(s) by Embark.

##// TODO: Subscribe to whisper messages

To receive the messages sent via Whisper, you can use `EmbarkJS.Messages.listenTo(options)`; a function Embark provides which helps us obtain messages based on the filters we wish to set. Let's implement this functionality, calling the function `addMessage(data, time)` each time a message is received:

```js
// Subscribe to whisper messages
EmbarkJS.Messages.listenTo({topic: [DEFAULT_CHANNEL]}, (error, message) => {
    if(error){
        alert("Error during subscription");
        return;
    }

    const {data, time} = message;

    addMessage(data, time);
});
```

Just like with `sendMessage`, `listenTo` also accepts an `option` object, with the following attributes:

1. `symKeyID`: if specified, it will send the message to this symmetric key id. Otherwise, it will send to a random symmetric key generated by Embark.
2. `usePrivateKey` is a boolean that indicates if you're going to use an private key for signing the message, or use Embark's autogenerated random keypair.
3. `privateKeyID` is required if you set `usePrivateKey` to `true`. Here you send the ID of the signing key.
4. `topic`: optional when using private keys. Can be an array of strings, or a string that contains the topic for the messages. Will be automatically encoded to a 4 bytes hex string(s).
5. `minPow` is the minimal Proof of Work requirement for incoming messages.

After adding this code, open two instances of the chat application and write a message. You'll see how it gets displayed in both windows.

## Final thoughts

Building a dApp that uses Whisper with Embark is amazingly easy! You can extend this tutorial to support private messages, just like we did in our previous tutorial for Getting started with Whisper.

Something toconsider is that, even through Embark lets you use Whisper in your dApps, it does not mean that anyone will be able to use it when browsing to your dApp. This is because whisper is not enabled by default in most nodes. You'll need to connect to a node that supports this feature (i.e. geth with the `--shh` flag).

Things will change in the future once Whisper gains more traction. Let's make that a reality together by building dApps which communicate between each other via Whisper!